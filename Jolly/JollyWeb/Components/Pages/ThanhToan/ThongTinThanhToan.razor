  @page "/checkout"
@using System.Globalization
@using System.ComponentModel.DataAnnotations
@using API.HeThong.IHeThong
@using API.Models.ViewModels.BanHang
@inject IXuLyDiaChi xuLyDiaChi
@inject NavigationManager Nav
<PageTitle>Checkout - Đặt hàng</PageTitle>

<link href="css/ThongTinThanhToan.css" rel="stylesheet" />

<div class="container">
    <div class="checkout-form">
        <div class="form-title">
            Thông tin giao hàng
            <button type="button" class="address-btn" @onclick="() => IsAddressModalVisible = true ">CHỌN ĐỊA CHỈ</button>
        </div>

        <EditForm Model="checkoutModel" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />

            <div class="form-row">
                <div class="form-group">
                    <label><span class="required">*</span>Họ và tên</label>
                    <InputText @bind-Value="checkoutModel.FullName" required />
                    <ValidationMessage For="@(() => checkoutModel.FullName)" />
                </div>
                <div class="form-group">
                    <label><span class="required">*</span>Số điện thoại</label>
                    <InputText @bind-Value="checkoutModel.PhoneNumber" required />
                    <ValidationMessage For="@(() => checkoutModel.PhoneNumber)" />
                </div>
            </div>

            <div class="form-row address-row">
                <div class="form-group">
                    <label><span class="required">*</span>Tỉnh/thành phố</label>
                    <InputSelect Value="@Tinh"
                                 ValueChanged="@((string value) => OnTinhChanged(value))"
                                 ValueExpression="() => Tinh">
                        <option value="">Chọn Tỉnh</option>
                        @foreach (var t in TinhThanh)
                        {
                            <option value="@t.Ten">@t.Ten</option>
                        }
                    </InputSelect>

                    <ValidationMessage For="@(() => checkoutModel.Province)" />
                </div>
                <div class="form-group">
                    <label><span class="required">*</span>Quận/huyện</label>
                    <InputSelect Value="@Huyen"
                                 ValueChanged="@((string value) => OnHuyenChanged(value))"
                                 ValueExpression="() => Huyen">
                        <option value="">Chọn quận/huyện</option>
                        @foreach (var h in HuyenXa)
                        {
                            <option value="@h.Ten">@h.Ten</option>
                        }
                    </InputSelect>
                    <ValidationMessage For="@(() => checkoutModel.District)" />
                </div>
                <div class="form-group">
                    <label><span class="required">*</span>Xã/thị trấn</label>
                    <InputSelect Value="@Phuong"
                                 ValueChanged="@((string value) => OnXaPhuongChanged(value))"
                                 ValueExpression="() => Phuong">
                        <option value="">Chọn xã/thị trấn</option>
                        @foreach (var x in XaPhuong)
                        {
                            <option value="@x.Ten">@x.Ten</option>
                        }
                    </InputSelect>
                    <ValidationMessage For="@(() => checkoutModel.Ward)" />
                </div>
            </div>

            <div class="form-group full-width">
                <label><span class="required">*</span>Địa chỉ cụ thể</label>
                <InputText @bind-Value="checkoutModel.SpecificAddress" required />
                <ValidationMessage For="@(() => checkoutModel.SpecificAddress)" />
            </div>

            <div class="form-group full-width">
                <label>Ghi chú</label>
                <InputTextArea @bind-Value="checkoutModel.Notes" placeholder="Nhập ghi chú đơn hàng..." />
            </div>

            <div class="payment-section">
                <div class="payment-title">Phương thức thanh toán</div>
                <div class="payment-options">
                    <div class="payment-option @(checkoutModel.PaymentMethod == "cod" ? "selected" : "")"
                         @onclick='() => SelectPayment("cod")'>
                        <div class="payment-icon cod">📦</div>
                        <span>Thanh toán khi nhận hàng</span>
                    </div>
                    <div class="payment-option @(checkoutModel.PaymentMethod == "vnpay" ? "selected" : "")"
                         @onclick='() => SelectPayment("vnpay")'>
                        <div class="payment-icon vnpay">💳</div>
                        <span>Thanh toán ngay</span>
                    </div>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="alert alert-success">@successMessage</div>
            }

            @if (!string.IsNullOrEmpty(infoMessage))
            {
                <div class="alert alert-info">@infoMessage</div>
            }

            <button type="submit" class="submit-btn">HOÀN THÀNH ĐẶT HÀNG</button>
        </EditForm>

        <a href="/cart" class="back-link">
            ← Quay lại giỏ hàng
        </a>
    </div>

    <div class="order-summary">
        <div class="product-item">
            <div class="quantity-badge">@product.Quantity</div>
            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiByeD0iOCIgZmlsbD0iIzM0OThlZGEiLz4KPHN2ZyB4PSIyMCIgeT0iMjAiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0yMC4xNSA4SDMuODVhLjg1Ljg1IDAgMCAwLS43OC45NGwuNTcgNi44M2EyIDIgMCAwIDAgMiAyLjc3aDEyLjc2YTIgMiAwIDAgMCAyLS43N2wuNTctNi44M2EuODUuODUgMCAwIDAtLjc4LS45NFoiLz4KPHBhdGggZD0iTTEyIDJjMS4xIDAgMiAuOSAyIDJ2M0gyVjRjMC0xLjEuOS0yIDItMloiLz4KPGF0dGggZD0iTTEyIDJjLS4xNSAyLjItLjMgNC40LS40NSA2LjZNMTIgMmMuMTUgMi4yLjMgNC40LjQ1IDYuNiIvPgo8L3N2Zz4KPC9zdmc+"
                 alt="@product.Name" class="product-image">
            <div class="product-info">
                <h4>@product.Name</h4>
                <div class="product-size">Size: @product.Size</div>
            </div>
            <div class="product-price">@product.Price.ToString("N0", CultureInfo.GetCultureInfo("vi-VN")) ₫</div>
        </div>

        <div class="discount-section">
            <input type="text" placeholder="Phiếu giảm giá" class="discount-input" @bind="discountCode" @bind:event="oninput">
            <button type="button" class="apply-btn" @onclick="ApplyDiscount">CHỌN</button>
        </div>

        <div class="summary-row shipping">
            <span>Phí vận chuyển</span>
            <span>@shippingFee.ToString("N0", CultureInfo.GetCultureInfo("vi-VN")) VNĐ</span>
        </div>

        <div class="summary-row discount">
            <span>Giảm giá</span>
            <span>@discountAmount.ToString("N0", CultureInfo.GetCultureInfo("vi-VN")) ₫</span>
        </div>

        <div class="delivery-date">
            Ngày nhận dự kiến: <strong>@deliveryDate.ToString("dd-MM-yyyy")</strong>
        </div>

        <div class="summary-row total">
            <span>Tổng số tiền</span>
            <span>@TotalAmount.ToString("N0", CultureInfo.GetCultureInfo("vi-VN")) ₫</span>
        </div>
    </div>
</div>
<ChonDiaChi Visible="@IsAddressModalVisible"
                                   OnAddressSelected="HandleAddressSelected"
                                   OnClose="@(() => IsAddressModalVisible = false)" />
@code {
    private CheckoutModel checkoutModel = new();
    private ProductItem product = new();
    private string discountCode = "";
    private int discountAmount = 0;
    private int shippingFee = 34000;
    private DateTime deliveryDate;
    private string successMessage = "";
    private string infoMessage = "";
    private bool IsAddressModalVisible = false;
    private List<DiaChiNhap> TinhThanh = new();
    private List<DiaChiNhap> HuyenXa = new();
    private List<DiaChiNhap> XaPhuong = new();

    protected override void OnInitialized()
    {
        product = new ProductItem
        {
            Name = "Balen Grey 2023 Bạc Dế nhựa",
            Size = "42",
            Price = 100000,
            Quantity = 1
        };

        deliveryDate = DateTime.Now.AddDays(3);


    }
    protected override async Task OnInitializedAsync()
    {
        TinhThanh = await xuLyDiaChi.ParseDiaChiAsync("wwwroot/Files/ThanhPho.txt");
    }
    private string Tinh = "";
    private async Task OnTinhChanged(string value)
    {
        Tinh = value;

        var tinh = TinhThanh.FirstOrDefault(t => t.Ten == Tinh);
        HuyenXa = tinh?.Con ?? new();
        XaPhuong = new();

        Huyen = "";
        Phuong = "";
        checkoutModel.Province = Tinh;
    }


    private string Huyen = "";
    void OnHuyenChanged(string value)
    {
        Huyen = value;

        var huyen = HuyenXa.FirstOrDefault(h => h.Ten == Huyen);
        XaPhuong = huyen?.Con ?? new();

        Phuong = "";
        checkoutModel.District = Huyen;
    }

    private string Phuong = "";
    void OnXaPhuongChanged(string value)
    {
        Phuong = value;
        checkoutModel.Ward = Phuong;
    }


    private void SelectPayment(string paymentType)
    {
        checkoutModel.PaymentMethod = paymentType;
        StateHasChanged();
    }



    private void ApplyDiscount()
    {
        if (!string.IsNullOrEmpty(discountCode))
        {
            switch (discountCode.ToUpper())
            {
                case "GIAM10K":
                    discountAmount = 10000;
                    infoMessage = $"Mã giảm giá \"{discountCode}\" đã được áp dụng!";
                    break;
                case "GIAM20K":
                    discountAmount = 20000;
                    infoMessage = $"Mã giảm giá \"{discountCode}\" đã được áp dụng!";
                    break;
                default:
                    discountAmount = 0;
                    infoMessage = $"Mã giảm giá \"{discountCode}\" không hợp lệ!";
                    break;
            }
            successMessage = "";
            StateHasChanged();
        }
    }

    private int TotalAmount => (product.Price * product.Quantity) + shippingFee - discountAmount;

    private async Task HandleSubmit()
    {
        await Task.Delay(1000);
        if (checkoutModel.PaymentMethod == "cod")
        {
            Nav.NavigateTo("/");
        }
        else if (checkoutModel.PaymentMethod == "vnpay")
        {

        }


        StateHasChanged();

    }
    private void HandleAddressSelected(DiaChi diaChi)
    {
        Tinh = diaChi.Tinh;
        var tinh = TinhThanh.FirstOrDefault(t => t.Ten == Tinh);
        HuyenXa = tinh?.Con ?? new();
        Huyen = diaChi.QuanHuyen;
        var huyen = HuyenXa.FirstOrDefault(h => h.Ten == Huyen);
        XaPhuong = huyen?.Con ?? new();
        Phuong = diaChi.XaPhuong;
        checkoutModel.SpecificAddress = diaChi.DiaChiCuThe;
    }
    public class CheckoutModel
    {
        [Required(ErrorMessage = "Họ và tên là bắt buộc")]
        public string FullName { get; set; } = "";

        [Required(ErrorMessage = "Số điện thoại là bắt buộc")]
        [Phone(ErrorMessage = "Số điện thoại không hợp lệ")]
        public string PhoneNumber { get; set; } = "";

        [Required(ErrorMessage = "Tỉnh/thành phố là bắt buộc")]
        public string Province { get; set; } = "";

        [Required(ErrorMessage = "Quận/huyện là bắt buộc")]
        public string District { get; set; } = "";

        [Required(ErrorMessage = "Xã/thị trấn là bắt buộc")]
        public string Ward { get; set; } = "";

        [Required(ErrorMessage = "Địa chỉ cụ thể là bắt buộc")]
        public string SpecificAddress { get; set; } = "";

        public string Notes { get; set; } = "";

        [Required]
        public string PaymentMethod { get; set; } = "cod";
    }

    public class ProductItem
    {
        public string Name { get; set; } = "";
        public string Size { get; set; } = "";
        public int Price { get; set; }
        public int Quantity { get; set; }
    }
}